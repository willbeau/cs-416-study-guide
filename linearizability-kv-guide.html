<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linearizability & Key-Value Systems - Student's Guide</title>

    <!-- Mermaid.js for diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#e8f5e9',
                primaryTextColor: '#1b5e20',
                primaryBorderColor: '#4caf50',
                lineColor: '#4caf50',
                secondaryColor: '#fff3e0',
                tertiaryColor: '#e3f2fd'
            }
        });
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #1b5e20;
            --accent-color: #4caf50;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --text-color: #263238;
            --text-light: #546e7a;
            --bg-color: #ffffff;
            --bg-light: #f5f7f5;
            --bg-code: #2b2b2b;
            --border-color: #e0e0e0;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background: var(--bg-light);
            font-size: 16px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            font-weight: 300;
        }

        .home-link {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .home-link:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Navigation */
        .nav-container {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
        }

        .nav-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            list-style: none;
        }

        .nav-links li a {
            display: inline-block;
            padding: 0.4rem 1rem;
            background: var(--bg-light);
            color: var(--text-color);
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .nav-links li a:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Content Sections */
        .section {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .section h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid var(--accent-color);
        }

        .section h3 {
            color: var(--secondary-color);
            font-size: 1.3rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .section h4 {
            color: var(--text-color);
            font-size: 1.1rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .section p {
            margin-bottom: 1rem;
        }

        .section ul, .section ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .section li {
            margin-bottom: 0.5rem;
        }

        /* Callout boxes */
        .callout {
            padding: 1.25rem 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid;
        }

        .callout-info {
            background: #e3f2fd;
            border-color: var(--info-color);
        }

        .callout-warning {
            background: #fff3e0;
            border-color: var(--warning-color);
        }

        .callout-success {
            background: #e8f5e9;
            border-color: var(--success-color);
        }

        .callout-danger {
            background: #ffebee;
            border-color: var(--danger-color);
        }

        .callout-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Code blocks */
        code {
            font-family: 'JetBrains Mono', monospace;
            background: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        pre {
            background: var(--bg-code);
            color: #f8f8f2;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        /* Diagrams */
        .diagram-container {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .diagram-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        /* Interactive elements */
        .interactive-demo {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            border: 2px solid var(--accent-color);
        }

        .interactive-demo h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .demo-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .demo-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .demo-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .demo-btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .demo-btn-secondary {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .demo-btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .demo-output {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            min-height: 200px;
            border: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        /* Timeline visualization */
        .timeline {
            position: relative;
            margin: 2rem 0;
            padding: 1rem 0;
        }

        .timeline-row {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            position: relative;
        }

        .timeline-label {
            width: 80px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .timeline-track {
            flex: 1;
            height: 40px;
            background: #f5f5f5;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .timeline-event {
            position: absolute;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .event-put { background: var(--info-color); }
        .event-get { background: var(--success-color); }
        .event-pending { background: #9e9e9e; opacity: 0.7; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--primary-color);
        }

        tr:hover {
            background: #f9f9f9;
        }

        /* Key concepts */
        .key-concept {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .key-concept h4 {
            color: white;
            margin-bottom: 0.75rem;
        }

        /* Comparison boxes */
        .comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .comparison-item {
            background: var(--bg-light);
            padding: 1.25rem;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .comparison-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .comparison-item h5 {
            color: var(--primary-color);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .comparison-item p {
            font-size: 0.9rem;
            margin: 0;
        }

        /* Analogy boxes */
        .analogy {
            background: #fff8e1;
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .analogy-title {
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Animation for operations */
        @keyframes slideIn {
            from { width: 0; opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .animate-slide {
            animation: slideIn 0.5s ease-out forwards;
        }

        /* Server visualization */
        .server-viz {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 3rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .server-box {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            min-width: 200px;
            text-align: center;
            transition: all 0.3s;
        }

        .server-box:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-lg);
        }

        .server-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .server-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .kv-store {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
        }

        .kv-entry {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .kv-entry:last-child {
            border-bottom: none;
        }

        .kv-key { color: var(--info-color); }
        .kv-value { color: var(--success-color); }
        .kv-version { color: var(--warning-color); font-size: 0.75rem; }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
            border-top: 1px solid var(--border-color);
            margin-top: 3rem;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .section { padding: 1.5rem; }
            .comparison { grid-template-columns: 1fr; }
            .server-viz { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <header class="header" style="position: relative;">
        <a href="index.html" class="home-link">Home</a>
        <h1>Linearizability & Key-Value Systems</h1>
        <p>A Comprehensive Guide for Distributed Systems Students</p>
    </header>

    <nav class="nav-container">
        <div class="nav">
            <div class="nav-title">Jump to Section</div>
            <ul class="nav-links">
                <li><a href="#intro">Introduction</a></li>
                <li><a href="#kv-basics">Key-Value Basics</a></li>
                <li><a href="#linearizability">Linearizability</a></li>
                <li><a href="#rpc-semantics">RPC Semantics</a></li>
                <li><a href="#version-numbers">Version Numbers</a></li>
                <li><a href="#distributed-locks">Distributed Locks</a></li>
                <li><a href="#unreliable-networks">Unreliable Networks</a></li>
                <li><a href="#real-world">Real-World Systems</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Introduction -->
        <section class="section" id="intro">
            <h2>Introduction</h2>
            <p>In distributed systems, one of the most fundamental challenges is building systems that behave correctly even when things go wrong. This guide explores key concepts that form the foundation of reliable distributed storage systems:</p>

            <ul>
                <li><strong>Key-Value Stores</strong> - The simplest and most versatile form of distributed storage</li>
                <li><strong>Linearizability</strong> - The gold standard for consistency in distributed systems</li>
                <li><strong>RPC Semantics</strong> - How to handle operations when networks fail</li>
                <li><strong>Distributed Locks</strong> - Coordinating access across machines</li>
            </ul>

            <div class="analogy">
                <div class="analogy-title">Real-World Analogy</div>
                <p>Think of a key-value store like a giant dictionary or phone book. You can look up a name (key) and get their phone number (value), or update someone's phone number. Simple, but incredibly powerful when done right in a distributed setting!</p>
            </div>
        </section>

        <!-- Key-Value Basics -->
        <section class="section" id="kv-basics">
            <h2>Key-Value Store Fundamentals</h2>

            <h3>What is a Key-Value Store?</h3>
            <p>A key-value store is the simplest form of database. It supports just two basic operations:</p>

            <div class="comparison">
                <div class="comparison-item">
                    <h5>Get(key)</h5>
                    <p>Retrieve the value associated with a key. Returns the value if the key exists, or an error if it doesn't.</p>
                </div>
                <div class="comparison-item">
                    <h5>Put(key, value)</h5>
                    <p>Store or update a value for a given key. Creates the key if it doesn't exist, or updates it if it does.</p>
                </div>
            </div>

            <h3>Why Key-Value Stores?</h3>
            <p>Despite their simplicity, key-value stores are incredibly powerful:</p>
            <ul>
                <li><strong>Simplicity</strong> - Easy to understand, implement, and reason about</li>
                <li><strong>Performance</strong> - O(1) lookups with hash-based implementations</li>
                <li><strong>Flexibility</strong> - Values can be anything: strings, JSON, binary data</li>
                <li><strong>Scalability</strong> - Easy to partition across multiple machines</li>
            </ul>

            <div class="interactive-demo">
                <h4>Interactive: Key-Value Operations</h4>
                <div class="demo-controls">
                    <button class="demo-btn demo-btn-primary" onclick="kvPut()">Put("user:1", "Alice")</button>
                    <button class="demo-btn demo-btn-primary" onclick="kvPut2()">Put("user:2", "Bob")</button>
                    <button class="demo-btn demo-btn-secondary" onclick="kvGet()">Get("user:1")</button>
                    <button class="demo-btn demo-btn-secondary" onclick="kvReset()">Reset</button>
                </div>
                <div class="demo-output" id="kv-output">
                    <div style="color: #666;">Click buttons to simulate key-value operations...</div>
                </div>
            </div>

            <h3>Server State Representation</h3>
            <p>A key-value server maintains an in-memory map. Here's a conceptual view:</p>

            <div class="server-viz">
                <div class="server-box">
                    <div class="server-icon">Server</div>
                    <div class="server-title">KV Server</div>
                    <div class="kv-store" id="kv-store-viz">
                        <div class="kv-entry">
                            <span class="kv-key">"config"</span>
                            <span><span class="kv-value">"production"</span> <span class="kv-version">v1</span></span>
                        </div>
                        <div class="kv-entry">
                            <span class="kv-key">"count"</span>
                            <span><span class="kv-value">"42"</span> <span class="kv-version">v3</span></span>
                        </div>
                        <div class="kv-entry">
                            <span class="kv-key">"lock:db"</span>
                            <span><span class="kv-value">"client-7"</span> <span class="kv-version">v1</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Linearizability -->
        <section class="section" id="linearizability">
            <h2>Linearizability: The Gold Standard</h2>

            <h3>What is Linearizability?</h3>
            <p>Linearizability is the strongest single-object consistency model. It provides the illusion that:</p>

            <div class="key-concept">
                <h4>Linearizability Guarantee</h4>
                <p>Every operation appears to execute instantaneously at some point between its invocation and response. The system behaves as if there's a single copy of data and all operations are atomic.</p>
            </div>

            <h3>The Two Key Properties</h3>
            <ol>
                <li><strong>Real-time ordering</strong>: If operation A completes before operation B starts, then A must appear to happen before B</li>
                <li><strong>Sequential consistency</strong>: All operations appear to occur in some sequential order that's consistent with program order</li>
            </ol>

            <div class="analogy">
                <div class="analogy-title">The Bank Teller Analogy</div>
                <p>Imagine a bank with one teller serving customers one at a time. Each customer's transaction (deposit, withdrawal, check balance) happens completely before the next customer is served. This is linearizable! Even if multiple customers are "in the queue" (have started but not finished), their transactions don't overlap - they happen in a clear order.</p>
            </div>

            <h3>Checking Linearizability</h3>
            <p>To verify if a history of operations is linearizable:</p>
            <ol>
                <li>Each operation has an <strong>invocation time</strong> (when it starts) and <strong>response time</strong> (when it completes)</li>
                <li>Find a <strong>linearization point</strong> for each operation - a single instant between invocation and response</li>
                <li>If operations can be ordered by their linearization points and produce valid results, the history is linearizable</li>
            </ol>

            <div class="diagram-container">
                <div class="diagram-title">Linearizable vs Non-Linearizable History</div>
                <pre class="mermaid">
sequenceDiagram
    participant C1 as Client 1
    participant S as Server
    participant C2 as Client 2

    Note over C1,C2: Linearizable Example
    C1->>S: Put(x, 1)
    S-->>C1: OK
    C2->>S: Get(x)
    S-->>C2: Returns 1

    Note over C1,C2: Both clients see consistent state
                </pre>
            </div>

            <h3>Why Linearizability Matters</h3>
            <div class="comparison">
                <div class="comparison-item">
                    <h5>Reasoning</h5>
                    <p>Makes distributed systems easier to reason about - behaves like a single machine</p>
                </div>
                <div class="comparison-item">
                    <h5>Correctness</h5>
                    <p>Provides strong guarantees for building correct concurrent applications</p>
                </div>
                <div class="comparison-item">
                    <h5>Composability</h5>
                    <p>Linearizable operations can be composed - if each op is linearizable, the whole system is</p>
                </div>
            </div>

            <div class="callout callout-warning">
                <div class="callout-title">The Cost of Linearizability</div>
                <p>Linearizability comes with performance costs. It requires coordination between nodes, which can increase latency. Many systems offer weaker consistency models (eventual consistency, causal consistency) for better performance. The choice depends on your application's requirements.</p>
            </div>

            <h3>Linearizability vs Other Consistency Models</h3>
            <table>
                <tr>
                    <th>Model</th>
                    <th>Guarantee</th>
                    <th>Performance</th>
                    <th>Use Case</th>
                </tr>
                <tr>
                    <td><strong>Linearizability</strong></td>
                    <td>Operations appear instantaneous</td>
                    <td>Slower (coordination needed)</td>
                    <td>Bank accounts, locks</td>
                </tr>
                <tr>
                    <td>Sequential Consistency</td>
                    <td>Same order seen by all</td>
                    <td>Medium</td>
                    <td>Shared memory systems</td>
                </tr>
                <tr>
                    <td>Causal Consistency</td>
                    <td>Causally related ops ordered</td>
                    <td>Faster</td>
                    <td>Social media feeds</td>
                </tr>
                <tr>
                    <td>Eventual Consistency</td>
                    <td>Eventually all see same value</td>
                    <td>Fastest</td>
                    <td>DNS, caching</td>
                </tr>
            </table>
        </section>

        <!-- RPC Semantics -->
        <section class="section" id="rpc-semantics">
            <h2>RPC Semantics: Handling Failures</h2>

            <h3>The Problem with Networks</h3>
            <p>In distributed systems, when a client sends a request to a server:</p>
            <ul>
                <li>The request might get lost</li>
                <li>The response might get lost</li>
                <li>The server might crash before/during/after processing</li>
                <li>The network might be slow, causing timeouts</li>
            </ul>

            <div class="analogy">
                <div class="analogy-title">The Restaurant Order Analogy</div>
                <p>You're at a busy restaurant and tell the waiter "I'd like the pasta." The waiter walks away. Minutes pass. Did they hear you? Did they place the order? Did the kitchen make it? Without feedback, you don't know if you should repeat your order (risking two pastas) or wait (risking no pasta).</p>
            </div>

            <h3>Three Semantics for RPCs</h3>

            <div class="comparison">
                <div class="comparison-item" style="border-left: 4px solid #f44336;">
                    <h5>At-Least-Once</h5>
                    <p><strong>Guarantee:</strong> Operation executes one or more times</p>
                    <p><strong>Implementation:</strong> Keep retrying until you get a response</p>
                    <p><strong>Problem:</strong> Duplicates! Bad for non-idempotent operations</p>
                    <p><strong>Example:</strong> "Add $100 to account" could add $200, $300...</p>
                </div>
                <div class="comparison-item" style="border-left: 4px solid #4caf50;">
                    <h5>At-Most-Once</h5>
                    <p><strong>Guarantee:</strong> Operation executes zero or one time</p>
                    <p><strong>Implementation:</strong> Server detects and ignores duplicates</p>
                    <p><strong>Problem:</strong> Client might not know if operation succeeded</p>
                    <p><strong>Example:</strong> Bank transfer - safe from duplicates</p>
                </div>
                <div class="comparison-item" style="border-left: 4px solid #2196f3;">
                    <h5>Exactly-Once</h5>
                    <p><strong>Guarantee:</strong> Operation executes exactly one time</p>
                    <p><strong>Implementation:</strong> Very difficult! Requires distributed consensus</p>
                    <p><strong>Reality:</strong> Often impossible in pure form; usually "effectively once"</p>
                </div>
            </div>

            <h3>Implementing At-Most-Once</h3>
            <p>To achieve at-most-once semantics, the server must:</p>
            <ol>
                <li><strong>Detect duplicates</strong> - Know when a request is a retry of a previous request</li>
                <li><strong>Remember results</strong> - Cache results to return for duplicate requests</li>
                <li><strong>Identify clients</strong> - Each client needs a unique ID</li>
                <li><strong>Track request IDs</strong> - Each request needs a sequence number</li>
            </ol>

            <div class="callout callout-info">
                <div class="callout-title">Version Numbers: A Simpler Approach</div>
                <p>Instead of tracking every request, we can use <strong>version numbers</strong> on data. Each key has a version that increments with each update. A Put operation includes the expected version - if it doesn't match, the Put is rejected. This makes Puts <strong>idempotent</strong>: repeating a Put with the same version either succeeds (first time) or fails with "version mismatch" (duplicate).</p>
            </div>
        </section>

        <!-- Version Numbers -->
        <section class="section" id="version-numbers">
            <h2>Version Numbers: Making Operations Safe</h2>

            <h3>The Conditional Put Pattern</h3>
            <p>A conditional Put operation looks like: <code>Put(key, value, expectedVersion)</code></p>

            <div class="diagram-container">
                <div class="diagram-title">How Conditional Put Works</div>
                <pre class="mermaid">
flowchart TD
    A[Client: Put key, value, version] --> B{Server: Does key exist?}
    B -->|No & version=0| C[Create key with value, version=1]
    B -->|No & version>0| D[Return ErrNoKey]
    B -->|Yes| E{version matches?}
    E -->|Yes| F[Update value, increment version]
    E -->|No| G[Return ErrVersion]
    C --> H[Return OK]
    F --> H
                </pre>
            </div>

            <h3>Why This Works</h3>
            <p>Version numbers solve several problems at once:</p>

            <table>
                <tr>
                    <th>Problem</th>
                    <th>How Version Numbers Help</th>
                </tr>
                <tr>
                    <td>Lost updates (two clients writing)</td>
                    <td>Second write fails with version mismatch</td>
                </tr>
                <tr>
                    <td>Duplicate requests from retries</td>
                    <td>Retry sees version already incremented, gets error (but op succeeded!)</td>
                </tr>
                <tr>
                    <td>Read-modify-write races</td>
                    <td>Compare-and-swap semantics prevent races</td>
                </tr>
            </table>

            <h3>The ErrMaybe Situation</h3>
            <p>There's a tricky edge case when retrying:</p>

            <div class="interactive-demo">
                <h4>Scenario: Client Retries After Timeout</h4>
                <div class="demo-output" style="line-height: 2;">
                    <div><strong>Step 1:</strong> Client sends Put("x", "hello", version=1)</div>
                    <div><strong>Step 2:</strong> Server receives, executes, version becomes 2</div>
                    <div><strong>Step 3:</strong> Response gets lost in network!</div>
                    <div><strong>Step 4:</strong> Client times out, retries Put("x", "hello", version=1)</div>
                    <div><strong>Step 5:</strong> Server sees version mismatch (current=2, requested=1)</div>
                    <div><strong>Step 6:</strong> Server returns ErrVersion</div>
                    <div style="color: #f57c00;"><strong>Problem:</strong> Client can't tell if:</div>
                    <div style="margin-left: 2rem;">- Original request succeeded (response lost) OR</div>
                    <div style="margin-left: 2rem;">- Another client updated first (both requests failed)</div>
                </div>
            </div>

            <div class="callout callout-danger">
                <div class="callout-title">The ErrMaybe Response</div>
                <p>When a client receives ErrVersion for a <strong>retried</strong> request, it should treat this as "ErrMaybe" - the operation might have succeeded. The client must be prepared to handle this uncertainty, perhaps by reading the current value to check.</p>
                <p><strong>Note:</strong> ErrVersion on the <strong>first</strong> attempt means the operation definitely failed (someone else updated first).</p>
            </div>
        </section>

        <!-- Distributed Locks -->
        <section class="section" id="distributed-locks">
            <h2>Distributed Locks</h2>

            <h3>Why Distributed Locks?</h3>
            <p>In a single program, we use mutexes to protect shared data. In distributed systems, we need <strong>distributed locks</strong> to coordinate access across multiple machines.</p>

            <div class="analogy">
                <div class="analogy-title">The Conference Room Booking Analogy</div>
                <p>Imagine a shared conference room with a sign-up sheet. To use the room, you write your name on the sheet. When you're done, you erase your name. If someone's name is already there, you wait. This is exactly how distributed locks work - a shared "sign-up sheet" (key-value pair) that everyone checks.</p>
            </div>

            <h3>Implementing Locks with Key-Value Stores</h3>
            <p>A lock can be implemented using a single key in a KV store:</p>

            <div class="comparison">
                <div class="comparison-item">
                    <h5>Acquire Lock</h5>
                    <ol style="font-size: 0.9rem; padding-left: 1.2rem;">
                        <li>Try to Put(lockKey, myClientId, version=0)</li>
                        <li>If success: Lock acquired!</li>
                        <li>If ErrVersion: Someone holds the lock</li>
                        <li>Retry after a delay</li>
                    </ol>
                </div>
                <div class="comparison-item">
                    <h5>Release Lock</h5>
                    <ol style="font-size: 0.9rem; padding-left: 1.2rem;">
                        <li>Get current version of lockKey</li>
                        <li>Put(lockKey, "", currentVersion)</li>
                        <li>This "clears" the lock</li>
                    </ol>
                </div>
            </div>

            <div class="diagram-container">
                <div class="diagram-title">Lock State Machine</div>
                <pre class="mermaid">
stateDiagram-v2
    [*] --> Unlocked: Initial State
    Unlocked --> Locked: Put(lock, clientId, 0) succeeds
    Locked --> Unlocked: Put(lock, "", v) succeeds
    Locked --> Locked: Put fails (ErrVersion)

    note right of Locked: Only lock holder can release
                </pre>
            </div>

            <h3>Handling Lock Failures</h3>
            <p>What if a client crashes while holding a lock? The lock is never released!</p>

            <div class="callout callout-warning">
                <div class="callout-title">The Lock Lease Pattern</div>
                <p>Real systems use <strong>leases</strong> - locks that automatically expire after a timeout. If a client crashes, the lock eventually releases itself. The client must periodically "renew" the lease to keep holding the lock.</p>
                <ul style="margin-top: 0.5rem;">
                    <li><strong>ZooKeeper:</strong> Uses ephemeral nodes that disappear when client session ends</li>
                    <li><strong>etcd:</strong> Uses lease-based locks with TTL (time-to-live)</li>
                    <li><strong>Redis:</strong> Uses SETNX with expiration (Redlock algorithm)</li>
                </ul>
            </div>

            <h3>Lock Safety Properties</h3>
            <table>
                <tr>
                    <th>Property</th>
                    <th>Description</th>
                    <th>Challenge</th>
                </tr>
                <tr>
                    <td><strong>Mutual Exclusion</strong></td>
                    <td>At most one client holds the lock</td>
                    <td>Concurrent Put operations must be handled atomically</td>
                </tr>
                <tr>
                    <td><strong>Deadlock Freedom</strong></td>
                    <td>Some client eventually acquires the lock</td>
                    <td>Requires fair scheduling or timeouts</td>
                </tr>
                <tr>
                    <td><strong>Fault Tolerance</strong></td>
                    <td>Lock works despite failures</td>
                    <td>Leases handle client crashes; replication handles server crashes</td>
                </tr>
            </table>
        </section>

        <!-- Unreliable Networks -->
        <section class="section" id="unreliable-networks">
            <h2>Handling Unreliable Networks</h2>

            <h3>Network Failure Modes</h3>
            <p>Networks can fail in many ways:</p>

            <div class="comparison">
                <div class="comparison-item">
                    <h5>Message Loss</h5>
                    <p>Request or response disappears entirely. Client sees timeout.</p>
                </div>
                <div class="comparison-item">
                    <h5>Message Delay</h5>
                    <p>Message arrives much later than expected. Can cause "ghost" responses.</p>
                </div>
                <div class="comparison-item">
                    <h5>Message Reordering</h5>
                    <p>Messages arrive in different order than sent.</p>
                </div>
                <div class="comparison-item">
                    <h5>Message Duplication</h5>
                    <p>Network retries might deliver same message twice.</p>
                </div>
            </div>

            <h3>The Retry Strategy</h3>
            <p>When a client doesn't receive a response, it should retry. But how?</p>

            <div class="callout callout-info">
                <div class="callout-title">Retry Best Practices</div>
                <ul>
                    <li><strong>Add delay between retries</strong> - Prevents overwhelming the server</li>
                    <li><strong>Use exponential backoff</strong> - Double the delay after each retry</li>
                    <li><strong>Add jitter</strong> - Randomize delays to prevent thundering herd</li>
                    <li><strong>Set a maximum retry count</strong> - Don't retry forever</li>
                    <li><strong>Make operations idempotent</strong> - Safe to retry without side effects</li>
                </ul>
            </div>

            <h3>Idempotency: The Key to Safe Retries</h3>
            <p>An operation is <strong>idempotent</strong> if executing it multiple times has the same effect as executing it once.</p>

            <table>
                <tr>
                    <th>Operation</th>
                    <th>Idempotent?</th>
                    <th>Why?</th>
                </tr>
                <tr>
                    <td>Get(key)</td>
                    <td style="color: #4caf50;">Yes</td>
                    <td>Reading doesn't change state</td>
                </tr>
                <tr>
                    <td>Put(key, value) [unconditional]</td>
                    <td style="color: #4caf50;">Yes</td>
                    <td>Sets to same value each time</td>
                </tr>
                <tr>
                    <td>Put(key, value, version) [conditional]</td>
                    <td style="color: #4caf50;">Yes</td>
                    <td>First succeeds, retries fail safely</td>
                </tr>
                <tr>
                    <td>Increment(key)</td>
                    <td style="color: #f44336;">No</td>
                    <td>Each call increases value</td>
                </tr>
                <tr>
                    <td>Append(key, data)</td>
                    <td style="color: #f44336;">No</td>
                    <td>Each call adds more data</td>
                </tr>
            </table>

            <div class="analogy">
                <div class="analogy-title">The Elevator Button Analogy</div>
                <p>Pressing an elevator button is idempotent - pressing it 10 times has the same effect as pressing it once (the elevator still only comes once). But putting coins in a vending machine is NOT idempotent - each coin adds to your total!</p>
            </div>
        </section>

        <!-- Real World Systems -->
        <section class="section" id="real-world">
            <h2>Real-World Systems</h2>

            <h3>Production Key-Value Stores</h3>
            <p>These concepts power real systems used by millions:</p>

            <div class="comparison">
                <div class="comparison-item">
                    <h5>Redis</h5>
                    <p>In-memory KV store with optional persistence. Supports atomic operations, pub/sub, and distributed locks (Redlock).</p>
                    <p><em>Used by: Twitter, GitHub, Stack Overflow</em></p>
                </div>
                <div class="comparison-item">
                    <h5>etcd</h5>
                    <p>Distributed KV store using Raft consensus. Provides linearizable operations, watches, and leases.</p>
                    <p><em>Used by: Kubernetes (stores all cluster state)</em></p>
                </div>
                <div class="comparison-item">
                    <h5>ZooKeeper</h5>
                    <p>Coordination service with hierarchical KV store. Strong consistency, ephemeral nodes, watches.</p>
                    <p><em>Used by: Kafka, Hadoop, HBase</em></p>
                </div>
                <div class="comparison-item">
                    <h5>Amazon DynamoDB</h5>
                    <p>Managed NoSQL database. Offers both eventual and strong consistency modes.</p>
                    <p><em>Used by: Amazon.com, Lyft, Netflix</em></p>
                </div>
            </div>

            <h3>Consistency Model Choices</h3>
            <p>Different systems make different tradeoffs:</p>

            <div class="diagram-container">
                <div class="diagram-title">The CAP Trade-off</div>
                <pre class="mermaid">
flowchart LR
    subgraph "Choose 2 of 3"
        C[Consistency]
        A[Availability]
        P[Partition Tolerance]
    end

    C ---|"etcd, ZooKeeper"| P
    A ---|"Cassandra, DynamoDB"| P
    C ---|"Traditional RDBMS"| A
                </pre>
            </div>

            <div class="callout callout-success">
                <div class="callout-title">The PACELC Extension</div>
                <p>CAP only considers behavior during partitions. PACELC adds: "Else (when no partition), choose between Latency and Consistency." This better captures the everyday tradeoffs systems make.</p>
                <ul>
                    <li><strong>PA/EL:</strong> Cassandra - highly available, low latency, eventual consistency</li>
                    <li><strong>PC/EC:</strong> etcd - consistent always, higher latency</li>
                    <li><strong>PA/EC:</strong> MongoDB - available during partitions, consistent otherwise</li>
                </ul>
            </div>

            <h3>Applying These Concepts</h3>
            <p>When building distributed systems, ask yourself:</p>
            <ul>
                <li><strong>What consistency do I need?</strong> - Bank transfers need linearizability; view counts can be eventual</li>
                <li><strong>How do I handle failures?</strong> - Retries with idempotency, or exactly-once with consensus?</li>
                <li><strong>What happens during network partitions?</strong> - Remain available with stale data, or unavailable but consistent?</li>
                <li><strong>How do I coordinate between clients?</strong> - Locks, leases, or optimistic concurrency?</li>
            </ul>
        </section>

        <!-- Summary -->
        <section class="section">
            <h2>Summary: Key Takeaways</h2>

            <div class="key-concept">
                <h4>The Big Ideas</h4>
                <ol>
                    <li><strong>Linearizability</strong> makes distributed systems behave like a single machine - powerful but costly</li>
                    <li><strong>Version numbers</strong> enable at-most-once semantics without tracking every request</li>
                    <li><strong>Conditional operations</strong> (compare-and-swap) prevent lost updates and enable locks</li>
                    <li><strong>Idempotency</strong> makes retry-based fault tolerance safe</li>
                    <li><strong>Distributed locks</strong> need leases to handle client failures</li>
                </ol>
            </div>

            <h3>Common Pitfalls</h3>
            <ul>
                <li><strong>Assuming networks are reliable</strong> - They're not. Always plan for failures.</li>
                <li><strong>Ignoring the ErrMaybe case</strong> - Retries can succeed silently before erroring.</li>
                <li><strong>Holding locks too long</strong> - Keep critical sections short.</li>
                <li><strong>Not using exponential backoff</strong> - Can overwhelm recovering servers.</li>
                <li><strong>Confusing consistency models</strong> - Know exactly what guarantees you need and have.</li>
            </ul>
        </section>
    </div>

    <footer class="footer">
        <p>CS 416 Distributed Systems - Linearizability & Key-Value Systems Guide</p>
        <p><a href="index.html">Back to Study Guide Hub</a></p>
    </footer>

    <script>
        // Interactive KV Store Demo
        let kvStore = {};
        let opLog = [];

        function logOp(op) {
            opLog.push(op);
            updateOutput();
        }

        function updateOutput() {
            const output = document.getElementById('kv-output');
            let html = '<div style="margin-bottom: 1rem;"><strong>Operation Log:</strong></div>';
            opLog.forEach((op, i) => {
                html += `<div style="margin: 0.25rem 0; padding: 0.25rem 0.5rem; background: ${op.type === 'PUT' ? '#e3f2fd' : '#e8f5e9'}; border-radius: 4px;">${i+1}. ${op.text}</div>`;
            });
            html += '<div style="margin-top: 1rem;"><strong>Current Store State:</strong></div>';
            html += '<div style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">';
            if (Object.keys(kvStore).length === 0) {
                html += '<span style="color: #999;">(empty)</span>';
            } else {
                for (let key in kvStore) {
                    html += `<div><span style="color: #1976d2;">"${key}"</span>: <span style="color: #388e3c;">"${kvStore[key].value}"</span> <span style="color: #f57c00; font-size: 0.8rem;">v${kvStore[key].version}</span></div>`;
                }
            }
            html += '</div>';
            output.innerHTML = html;
        }

        function kvPut() {
            kvStore["user:1"] = { value: "Alice", version: (kvStore["user:1"]?.version || 0) + 1 };
            logOp({ type: 'PUT', text: 'Put("user:1", "Alice") -> OK' });
        }

        function kvPut2() {
            kvStore["user:2"] = { value: "Bob", version: (kvStore["user:2"]?.version || 0) + 1 };
            logOp({ type: 'PUT', text: 'Put("user:2", "Bob") -> OK' });
        }

        function kvGet() {
            if (kvStore["user:1"]) {
                logOp({ type: 'GET', text: `Get("user:1") -> "${kvStore["user:1"].value}" (v${kvStore["user:1"].version})` });
            } else {
                logOp({ type: 'GET', text: 'Get("user:1") -> ErrNoKey' });
            }
        }

        function kvReset() {
            kvStore = {};
            opLog = [];
            updateOutput();
        }
    </script>
</body>
</html>
